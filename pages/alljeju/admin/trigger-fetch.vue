<template>
  <div>
    <h2 class="text-2xl font-semibold mb-6">ìˆ˜ë™ ë°ì´í„° ìˆ˜ì§‘ íŠ¸ë¦¬ê±°</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <!-- ì¶•ì œ ë°ì´í„° ìˆ˜ì§‘ -->
      <div class="p-6 bg-white rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-3">ì¶•ì œ ì •ë³´</h3>
        <p class="text-sm text-gray-600 mb-4">ì¶•ì œ ê´€ë ¨ ìµœì‹  ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
        <button
          @click="triggerFetch('festivals')"
          :disabled="loading.festivals"
          class="w-full bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 disabled:bg-gray-400 flex items-center justify-center">
          <svg v-if="loading.festivals" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ loading.festivals ? 'ìˆ˜ì§‘ ì¤‘...' : 'ì¶•ì œ ë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰' }}
        </button>
        <div v-if="results.festivals" class="mt-4 p-3 rounded-md text-sm"
             :class="results.festivals.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
          {{ results.festivals.message }}
        </div>
      </div>

      <!-- ì „ì‹œíšŒ ë°ì´í„° ìˆ˜ì§‘ -->
      <div class="p-6 bg-white rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-3">ì „ì‹œíšŒ ì •ë³´</h3>
        <p class="text-sm text-gray-600 mb-4">ì „ì‹œíšŒ ê´€ë ¨ ìµœì‹  ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
        <button
          @click="triggerFetch('exhibitions')"
          :disabled="loading.exhibitions"
          class="w-full bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600 disabled:bg-gray-400 flex items-center justify-center">
          <svg v-if="loading.exhibitions" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ loading.exhibitions ? 'ìˆ˜ì§‘ ì¤‘...' : 'ì „ì‹œíšŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤í–‰' }}
        </button>
        <div v-if="results.exhibitions" class="mt-4 p-3 rounded-md text-sm"
             :class="results.exhibitions.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
          {{ results.exhibitions.message }}
        </div>
      </div>

      <!-- ë³µì§€ ì„œë¹„ìŠ¤ ë°ì´í„° ìˆ˜ì§‘ -->
      <div class="p-6 bg-white rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-3">ë³µì§€ ì„œë¹„ìŠ¤ ì •ë³´</h3>
        <p class="text-sm text-gray-600 mb-4">ë³µì§€ ì„œë¹„ìŠ¤ ê´€ë ¨ ìµœì‹  ë°ì´í„°ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
        <button
          @click="triggerFetch('welfare-services')"
          :disabled="loading.welfareServices"
          class="w-full bg-sky-500 text-white px-4 py-2 rounded hover:bg-sky-600 disabled:bg-gray-400 flex items-center justify-center">
           <svg v-if="loading.welfareServices" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ loading.welfareServices ? 'ìˆ˜ì§‘ ì¤‘...' : 'ë³µì§€ ì„œë¹„ìŠ¤ ìˆ˜ì§‘ ì‹¤í–‰' }}
        </button>
        <div v-if="results.welfareServices" class="mt-4 p-3 rounded-md text-sm"
             :class="results.welfareServices.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
          {{ results.welfareServices.message }}
        </div>
      </div>

      <!-- ì£¼ìœ ì†Œ ë°ì´í„° ìˆ˜ì§‘ -->
      <div class="p-6 bg-white rounded-lg shadow">
        <h3 class="text-xl font-semibold mb-3">ì£¼ìœ ì†Œ ì •ë³´</h3>
        <p class="text-sm text-gray-600 mb-4">ì œì£¼ë„ ì£¼ìœ ì†Œ ë° ê°€ê²© ì •ë³´ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</p>
        <button
          @click="triggerFetch('gas-stations')"
          :disabled="loading.gasStations"
          class="w-full bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 disabled:bg-gray-400 flex items-center justify-center">
           <svg v-if="loading.gasStations" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ loading.gasStations ? 'ìˆ˜ì§‘ ì¤‘...' : 'ì£¼ìœ ì†Œ ì •ë³´ ìˆ˜ì§‘ ì‹¤í–‰' }}
        </button>
        <div v-if="results.gasStations" class="mt-4 p-3 rounded-md text-sm"
             :class="results.gasStations.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
          {{ results.gasStations.message }}
        </div>
      </div>
    </div>

  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';

definePageMeta({
  layout: 'admin',
  middleware: ['auth']
});

type SourceName = 'festivals' | 'exhibitions' | 'welfare-services' | 'gas-stations';

const loading = ref({
  festivals: false,
  exhibitions: false,
  welfareServices: false, // welfare-services í‚¤ë¥¼ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ë³€ê²½
  gasStations: false, // gas-stations í‚¤ë¥¼ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ë³€ê²½
});

const results = ref<{
  [key in SourceName | 'welfareServices' | 'gasStations']?: { success: boolean; message: string }
}>({});

async function triggerFetch(sourceName: SourceName) {
  const key = sourceName === 'welfare-services' ? 'welfareServices' :
              sourceName === 'gas-stations' ? 'gasStations' : sourceName;
  loading.value[key] = true;
  results.value[key] = undefined; // ì´ì „ ê²°ê³¼ ì´ˆê¸°í™”

  // ìƒì„¸í•œ ì½˜ì†” ë¡œê¹… ì‹œì‘
  const startTime = Date.now();
  console.group(`ğŸš€ [ADMIN-TRIGGER] ${sourceName.toUpperCase()} ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘`);
  console.log(`â° ì‹œì‘ ì‹œê°„: ${new Date().toLocaleString()}`);
  console.log(`ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸: /api/admin/trigger-fetch/${sourceName}`);

  if (sourceName === 'gas-stations') {
    console.log(`â›½ ì£¼ìœ ì†Œ ë°ì´í„° ìˆ˜ì§‘ ìƒì„¸ ì •ë³´:`);
    console.log(`  - ì™¸ë¶€ API: ì œì£¼ë„ ì£¼ìœ ì†Œ ì •ë³´ API`);
    console.log(`  - ìˆ˜ì§‘ ë°ì´í„°: ì£¼ìœ ì†Œ ê¸°ë³¸ ì •ë³´ + ê°€ê²© ì •ë³´`);
    console.log(`  - ì¢Œí‘œ ë³€í™˜: KATEC â†’ WGS84 (ì¹´ì¹´ì˜¤ API ì‚¬ìš©)`);
    console.log(`  - ì˜ˆìƒ ì†Œìš” ì‹œê°„: 2-3ë¶„`);
  }

  try {
    console.log(`ğŸ“¤ API ìš”ì²­ ì „ì†¡ ì¤‘...`);

    const response = await $fetch(`/api/admin/trigger-fetch/${sourceName}`, {
      method: 'POST',
    });

    const endTime = Date.now();
    const duration = endTime - startTime;

    console.log(`ğŸ“¥ API ì‘ë‹µ ìˆ˜ì‹  ì™„ë£Œ (${duration}ms)`);
    console.log(`ğŸ“Š ì‘ë‹µ ë°ì´í„°:`, response);

    // íƒ€ì… ë‹¨ì–¸ì„ ì‚¬ìš©í•˜ì—¬ responseì˜ íƒ€ì…ì„ ëª…ì‹œ
    const typedResponse = response as {
      success: boolean;
      message: string;
      error?: string;
      details?: any;
      timing?: any;
    };

    if (typedResponse.success) {
      console.log(`âœ… ë°ì´í„° ìˆ˜ì§‘ íŠ¸ë¦¬ê±° ì„±ê³µ`);
      if (typedResponse.details) {
        console.log(`ğŸ“‹ ì¶”ê°€ ì •ë³´:`, typedResponse.details);
      }
      if (typedResponse.timing) {
        console.log(`â±ï¸ íƒ€ì´ë° ì •ë³´:`, typedResponse.timing);
      }

      results.value[key] = {
        success: true,
        message: typedResponse.message || 'ë°ì´í„° ìˆ˜ì§‘ì´ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.'
      };

      if (sourceName === 'gas-stations') {
        console.log(`â›½ ì£¼ìœ ì†Œ ë°ì´í„° ìˆ˜ì§‘ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.`);
        console.log(`ğŸ“ ì§„í–‰ ìƒí™©ì€ ì„œë²„ ë¡œê·¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
      }
    } else {
      console.error(`âŒ ë°ì´í„° ìˆ˜ì§‘ íŠ¸ë¦¬ê±° ì‹¤íŒ¨`);
      console.error(`ğŸ’¬ ì˜¤ë¥˜ ë©”ì‹œì§€: ${typedResponse.message || typedResponse.error}`);

      results.value[key] = {
        success: false,
        message: typedResponse.message || typedResponse.error || 'ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
      };
    }
  } catch (error: any) {
    const endTime = Date.now();
    const duration = endTime - startTime;

    console.error(`ğŸ’¥ API ìš”ì²­ ì‹¤íŒ¨ (${duration}ms)`);
    console.error(`ğŸ” ì˜¤ë¥˜ ìƒì„¸ ì •ë³´:`, error);
    console.error(`ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:`, navigator.onLine ? 'ì˜¨ë¼ì¸' : 'ì˜¤í”„ë¼ì¸');

    if (error.data) {
      console.error(`ğŸ“„ ì„œë²„ ì‘ë‹µ ë°ì´í„°:`, error.data);
    }
    if (error.statusCode) {
      console.error(`ğŸ”¢ HTTP ìƒíƒœ ì½”ë“œ: ${error.statusCode}`);
    }

    results.value[key] = {
      success: false,
      message: error.data?.message || error.message || `An unexpected error occurred while triggering ${sourceName}.`
    };
  } finally {
    const totalTime = Date.now() - startTime;
    console.log(`â° ì´ ì†Œìš” ì‹œê°„: ${totalTime}ms`);
    console.log(`ğŸ ${sourceName.toUpperCase()} íŠ¸ë¦¬ê±° ì™„ë£Œ: ${new Date().toLocaleString()}`);
    console.groupEnd();

    loading.value[key] = false;
  }
}
</script>

<style scoped>
/* í˜ì´ì§€ë³„ ìŠ¤íƒ€ì¼ */
</style>
